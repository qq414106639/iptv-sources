name: Auto Merge IPTV Sources

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'sources.json'    # å½“é…ç½®æ–‡ä»¶ä¿®æ”¹æ—¶ä¹Ÿè§¦å‘

jobs:
  merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        
    - name: Merge IPTV sources
      run: |
        # åˆ›å»ºåˆå¹¶è„šæœ¬
        cat > merge.js << 'EOF'
        const https = require('https');
        const fs = require('fs');
        
        // ä¸¤ä¸ªåŸå§‹æº
        const sources = [
          'https://cdn.jsdelivr.net/gh/cyh92/iptv-api-cctv@master/output/ipv6/result.m3u',
          'https://cdn.jsdelivr.net/gh/cyh92/iptv-api-weishi@master/output/ipv6/result.m3u'
        ];
        
        async function fetchSource(url) {
          return new Promise((resolve, reject) => {
            https.get(url, (res) => {
              let data = '';
              res.on('data', (chunk) => data += chunk);
              res.on('end', () => resolve(data));
            }).on('error', reject);
          });
        }
        
        async function main() {
          let merged = '#EXTM3U\n';
          merged += '# è‡ªåŠ¨åˆå¹¶æ—¶é—´: ' + new Date().toLocaleString() + '\n\n';
          
          for (let i = 0; i < sources.length; i++) {
            try {
              console.log('æ­£åœ¨è·å–æº:', sources[i]);
              const content = await fetchSource(sources[i]);
              
              // ç§»é™¤EXTM3Uå¤´éƒ¨
              let processed = content;
              if (processed.startsWith('#EXTM3U')) {
                processed = processed.substring(processed.indexOf('\n') + 1);
              }
              
              merged += processed.trim() + '\n\n';
              console.log('è·å–æˆåŠŸ');
              
            } catch (error) {
              console.error('è·å–å¤±è´¥:', error.message);
            }
          }
          
          // ä¿å­˜æ–‡ä»¶
          fs.writeFileSync('merged.m3u', merged);
          console.log('åˆå¹¶å®Œæˆï¼Œä¿å­˜ä¸º merged.m3u');
        }
        
        main().catch(console.error);
        EOF
        
        # è¿è¡Œåˆå¹¶è„šæœ¬
        node merge.js
        
    - name: Commit merged file
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet; then
          echo "æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          git add merged.m3u
          git commit -m "ğŸ¤– Auto merge: $(date '+%Y-%m-%d %H:%M')"
          git push
        fi
