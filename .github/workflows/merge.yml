name: Merge IPTV Sources

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup curl
      run: |
        # ç¡®ä¿curlå¯ç”¨
        which curl || apt-get update && apt-get install -y curl
    
    - name: Download CCTV source
      run: |
        echo "æ­£åœ¨ä¸‹è½½å¤®è§†æº..."
        curl -s -L "https://cdn.jsdelivr.net/gh/cyh92/iptv-api-cctv@master/output/ipv6/result.m3u" \
          -o cctv.m3u || echo "å¤®è§†æºä¸‹è½½å¤±è´¥"
        
        # æ£€æŸ¥æ–‡ä»¶
        if [ -f cctv.m3u ]; then
          echo "å¤®è§†æºå¤§å°: $(wc -l < cctv.m3u) è¡Œ"
        else
          echo "å¤®è§†æºæ–‡ä»¶ä¸å­˜åœ¨"
        fi
    
    - name: Download Weishi source
      run: |
        echo "æ­£åœ¨ä¸‹è½½å«è§†æº..."
        curl -s -L "https://cdn.jsdelivr.net/gh/cyh92/iptv-api-weishi@master/output/ipv6/result.m3u" \
          -o weishi.m3u || echo "å«è§†æºä¸‹è½½å¤±è´¥"
        
        if [ -f weishi.m3u ]; then
          echo "å«è§†æºå¤§å°: $(wc -l < weishi.m3u) è¡Œ"
        else
          echo "å«è§†æºæ–‡ä»¶ä¸å­˜åœ¨"
        fi
    
    - name: Merge files
      run: |
        echo "å¼€å§‹åˆå¹¶..."
        echo "#EXTM3U" > merged.m3u
        echo "# è‡ªåŠ¨åˆå¹¶æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> merged.m3u
        echo "" >> merged.m3u
        
        # åˆå¹¶å¤®è§†ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œï¼‰
        if [ -f cctv.m3u ]; then
          echo "# å¤®è§†é¢‘é“" >> merged.m3u
          tail -n +2 cctv.m3u >> merged.m3u
          echo "" >> merged.m3u
        fi
        
        # åˆå¹¶å«è§†ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œï¼‰
        if [ -f weishi.m3u ]; then
          echo "# å«è§†é¢‘é“" >> merged.m3u
          tail -n +2 weishi.m3u >> merged.m3u
        fi
        
        echo "åˆå¹¶å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(wc -l < merged.m3u) è¡Œ"
        
        # æ˜¾ç¤ºå‰5è¡Œ
        echo "å‰5è¡Œå†…å®¹:"
        head -5 merged.m3u
    
    - name: Commit merged file
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
        ls -la *.m3u
        
        if [ -f merged.m3u ]; then
          echo "æäº¤æ–‡ä»¶..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add merged.m3u
          git status
          git commit -m "ğŸ¤– Auto merge: $(date '+%Y-%m-%d %H:%M')" || echo "æ²¡æœ‰å˜åŒ–"
          git push
        else
          echo "é”™è¯¯: merged.m3u æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
